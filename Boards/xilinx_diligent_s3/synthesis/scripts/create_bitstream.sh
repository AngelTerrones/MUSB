#!/bin/bash
#-------------------------------------------------------------------------------
# Copyright (C) 2015 Angel Terrones <angelterrones@gmail.com>
#-------------------------------------------------------------------------------
#
# File Name: create_bitstream.sh
#
# Author:
#             - Angel Terrones <angelterrones@gmail.com>
# Description:
#       Generate FPGA bitstream
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Parameter check
#-------------------------------------------------------------------------------
EXPECTED_ARGS=3
if [ $# -ne $EXPECTED_ARGS ]; then
    echo ""
    echo "ERROR : wrong number of arguments"
    echo "USAGE : create_bitstream.sh <fpga part> <build folder> <bitstream folder>"
    echo ""
    exit 1
fi

#-------------------------------------------------------------------------------
# folders
#-------------------------------------------------------------------------------
BUILD_FOLDER=$2

#-------------------------------------------------------------------------------
# move to workspace
#-------------------------------------------------------------------------------
cd $BUILD_FOLDER

#-------------------------------------------------------------------------------
# create link to UCF file
#-------------------------------------------------------------------------------
ln -s ../scripts/pinout_musoc.ucf musoc.ucf

#-------------------------------------------------------------------------------
#link include file
#-------------------------------------------------------------------------------
ln -s ../../rtl/verilog/include/musb_defines.v

#-------------------------------------------------------------------------------
# Execute XFLOW
#-------------------------------------------------------------------------------
xflow -p $1 -implement high_effort.opt         \
            -config bitgen.opt                 \
            -synth ../scripts/xst_verilog.opt  \
            ./musoc.prj

#-------------------------------------------------------------------------------
# copy bitstream to root folder
#-------------------------------------------------------------------------------
cd ..
cp -f ./build/musoc.bit $3/.
