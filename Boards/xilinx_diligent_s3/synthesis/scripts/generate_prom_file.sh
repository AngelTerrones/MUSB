#!/bin/bash
#-------------------------------------------------------------------------------
# Copyright (C) 2015 Angel Terrones <angelterrones@gmail.com>
#-------------------------------------------------------------------------------
#
# File Name: generate_prom_file.sh
#
# Author:
#             - Angel Terrones <angelterrones@gmail.com>
# Description:
#       Generate PROM file
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Parameter check
#-------------------------------------------------------------------------------
EXPECTED_ARGS=3
if [ $# -ne $EXPECTED_ARGS ]; then
    echo ""
    echo "ERROR   : wrong number of arguments"
    echo "USAGE   : ./generate_prom_file.sh <bitstream name> <bitstream folder> <build folder>"
    echo ""
    exit 1
fi

#-------------------------------------------------------------------------------
# Check if requiered file exists
#-------------------------------------------------------------------------------
bitstreamfile=$2/$1.bit;

if [ ! -e $bitstreamfile ]; then
    echo
    echo "Bitstream file does not exist: $bitstreamfile"
    echo
    exit 1
fi

#-------------------------------------------------------------------------------
# move to build folder
#-------------------------------------------------------------------------------
cd $3
echo $(pwd)
#-------------------------------------------------------------------------------
# copy impact script & update
#-------------------------------------------------------------------------------
cp ../scripts/impact_generate_prom_file.batch .
sed -i "s/BITSTREAM_NAME/$1/g" ./impact_generate_prom_file.batch

#-------------------------------------------------------------------------------
# Create PROM
#-------------------------------------------------------------------------------
impact -batch ./impact_generate_prom_file.batch

#-------------------------------------------------------------------------------
# Copy PROM to bitstream folder
#-------------------------------------------------------------------------------
cp -f ./$1.mcs ../$2

#-------------------------------------------------------------------------------
# return
#-------------------------------------------------------------------------------
cd ..
